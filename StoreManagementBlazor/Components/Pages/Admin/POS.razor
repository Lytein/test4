@page "/pos"
@rendermode InteractiveServer
@using StoreManagementBlazorApp.Entities
@using StoreManagementBlazorApp.Services
@using System.Globalization
@inject StoreService Store

<div class="container-fluid py-3">
    <div class="row g-3">

        <!-- ================= PRODUCTS ================= -->
        <div class="col-12 col-lg-8">
            <div class="card h-100 shadow-sm">
                <div class="card-header fw-bold">
                    Sản phẩm
                </div>

                <div class="card-body">
                    <input class="form-control mb-3"
                           placeholder="Tìm sản phẩm...(Mã bar_code)"
                           @bind="SearchText" />

                    <div class="row g-3">
                        @foreach (var p in FilteredProducts)
                        {
                            <div class="col-12 col-md-6">
                                <div class="card shadow-sm h-100 product-card"
                                     style="cursor:pointer"
                                     @onclick="() => AddToCart(p)">

                                    <div class="row g-0 h-100">

                                        <!-- IMAGE (LEFT) -->
                                        @* <div class="col-4">
                                            <div class="h-100">
                                                <img src="@(string.IsNullOrEmpty(p.Image) ? "/images/phone.png" : p.Image)"
                                                     class="img-fluid h-100 w-100 object-fit-cover rounded-start"
                                                     alt="@p.Name" />
                                            </div>
                                        </div> *@

                                        <!-- INFO (RIGHT) -->
                                        <div class="col-8">
                                            <div class="card-body py-2 px-3">

                                                <div class="fw-bold text-truncate">
                                                    @p.Name
                                                </div>

                                                <div class="text-danger fw-semibold mt-1">
                                                    @string.Format(new CultureInfo("vi-VN"), "{0:N0} đ", p.Price)
                                                </div>

                                                <small class="text-muted">
                                                    Tồn kho: @p.Stock
                                                </small>

                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= CART ================= -->
        <div class="col-12 col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header fw-bold">
                    Thanh toán
                </div>

                <div class="card-body d-flex flex-column">

                    @if (Cart.Any())
                    {
                        <div class="flex-grow-1 overflow-auto">
                            @foreach (var item in Cart)
                            {
                                <div class="border-bottom py-2">

                                    <div class="fw-semibold">
                                        @item.Product.Name
                                    </div>

                                    <div class="d-flex align-items-center gap-2 mt-1">
                                        <button class="btn btn-sm btn-outline-secondary"
                                                @onclick="() => UpdateQty(item, item.Quantity - 1)">
                                            -
                                        </button>

                                        <input type="number"
                                               min="1"
                                               class="form-control form-control-sm text-center"
                                               style="width:60px"
                                               @bind="item.Quantity" />


                                        <button class="btn btn-sm btn-outline-secondary"
                                                @onclick="() => UpdateQty(item, item.Quantity + 1)">
                                            +
                                        </button>

                                        <span class="ms-auto">
                                            @string.Format(new CultureInfo("vi-VN"), "{0:N0} đ",
                                            item.Product.Price* item.Quantity)
                                </span>

                                <button class="btn btn-sm btn-outline-danger"
                                        @onclick="() => RemoveFromCart(item.Product.Id)">
                                    ✕
                                </button>
                            </div>
                        </div>
                                                }
                        </div>

                        <!-- DISCOUNT -->
                        <div class="mt-3">
                            <input class="form-control"
                                   placeholder="Mã giảm giá"
                                   @bind="DiscountCode"
                                   disabled="@(_appliedPromotion != null)" />

                            @if (_appliedPromotion == null)
                            {
                                <button class="btn btn-primary w-100 mt-2"
                                        @onclick="ApplyPromotion">
                                    Áp dụng
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-warning w-100 mt-2"
                                        @onclick="RemoveDiscount">
                                    Hủy (@_appliedPromotion.PromoCode)
                                </button>
                            }
                        </div>

                        <!-- SUMMARY -->
                        <div class="border-top pt-3 mt-3">
                            <div class="d-flex justify-content-between">
                                <span>Tạm tính</span>
                                <span>@string.Format(new CultureInfo("vi-VN"), "{0:N0} đ", Subtotal)</span>
                            </div>

                            @if (DiscountAmount > 0)
                            {
                                <div class="d-flex justify-content-between text-success">
                                    <span>Giảm</span>
                                    <span>-@string.Format(new CultureInfo("vi-VN"), "{0:N0} đ", DiscountAmount)</span>
                                </div>
                            }

                            <div class="d-flex justify-content-between fw-bold fs-5 mt-2">
                                <span>TỔNG</span>
                                <span class="text-danger">
                                    @string.Format(new CultureInfo("vi-VN"), "{0:N0} đ", Total)
                                </span>
                            </div>
                        </div>

                        <button class="btn btn-success w-100 mt-3"
                                @onclick="Checkout">
                            Thanh toán
                        </button>
                    }
                    else
                    {
                        <p class="text-muted text-center mt-5">Giỏ hàng trống</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    string SearchText = "";
    string DiscountCode = "";

    List<CartItem> Cart => Store.Cart;

    Promotion? _appliedPromotion;
    List<Promotion> Promotions = new();



    IEnumerable<Product> FilteredProducts =>
        Store.Products.Where(p =>
            p.bar_code.Contains(SearchText, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        if (!Store.Products.Any())
        {
            await Store.LoadProductsAsync(); 
        }
        if (!Store.Promotions.Any())
            await Store.LoadPromotionsAsync();

        Promotions = Store.Promotions;
    }

    void AddToCart(Product product)
        => Store.AddToCart(product, 1);

    void RemoveFromCart(int productId)
        => Store.RemoveFromCart(productId);

    void UpdateQty(CartItem item, int qty)
        => Store.UpdateCartQuantity(item.Product.Id, qty);

    decimal Subtotal => Cart.Sum(c => c.Product.Price * c.Quantity);

    decimal DiscountAmount
    {
        get
        {
            if (_appliedPromotion == null) return 0;

            decimal discount = 0;

            if (_appliedPromotion.DiscountType == "percent")
            {
                discount = Subtotal * (_appliedPromotion.DiscountValue / 100);
            }
            else // fixed
            {
                discount = _appliedPromotion.DiscountValue;
            }

            // không cho giảm quá tiền
            return Math.Min(discount, Subtotal);
        }
    }



    decimal Total => Math.Max(0, Subtotal - DiscountAmount);

    void ApplyPromotion()
    {
        var today = DateTime.Today;

        var code = DiscountCode.Trim();

        var promo = Promotions.FirstOrDefault(p =>
            p.PromoCode.Equals(code, StringComparison.OrdinalIgnoreCase) &&
            p.Status == "active" &&
            p.StartDate <= today &&
            p.EndDate >= today &&
            Subtotal >= p.MinOrderAmount &&
            (p.UsageLimit == 0 || p.UsedCount < p.UsageLimit)
        );


        if (promo == null)
        {
            // TODO: show toast / alert
            return;
        }

        _appliedPromotion = promo;
    }


    void RemoveDiscount()
    {
        _appliedPromotion = null;
        DiscountCode = "";
    }

    void Checkout()
    {
        Store.ClearCart();
        RemoveDiscount();
    }
}
