@page "/products"
@using StoreManagementBlazorApp.Entities
@using StoreManagementBlazorApp.Services
@inject StoreService Store
@inject ApiService ProductAPI
@inject IJSRuntime JS
@rendermode InteractiveServer

<h1 class="text-3xl font-bold mb-2">Products</h1>

<div class="d-flex justify-content-between align-items-center my-4">
    <input class="form-control me-2" style="flex:1" placeholder="Search Products..." @bind="searchQuery" />
    @if (Store.IsAdmin) 
    {   
        <button class="btn btn-primary" @onclick="() => OpenAdd()">Add Customer</button>            
    }
</div>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>Name</th>
            <th>Category</th>
            <th>Bar_code</th>
            <th>Unit</th>
            <th>Price</th>
            <th>Created At</th>
            @if (Store.IsAdmin)
            {
                <th class="text-center">Activity</th>            
            }
        </tr>
    </thead>
    <tbody>
        @if (PagedProducts.Any())
        {
            @foreach (var p in PagedProducts)
            {
                <tr>
                    <td>@p.Name</td>
                    <td>@p.Category</td>
                    <td>@p.bar_code</td>
                    <td>@p.unit</td>
                    <td>@p.Price</td>
                    <td>@p.created_at.ToString("dd/MM/yyyy")</td>
                    @if (Store.IsAdmin)
                    {
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => OpenEdit(p)">Edit</button>
                            <button class="btn btn-sm btn-outline-danger ms-2" @onclick="() => ConfirmDelete(p.Id)">Delete</button>
                        </td>                    
                    }
                </tr>
            }
        }
        else
        {
            <tr><td colspan="6">Loading...</td></tr>
        }
    </tbody>
</table>

@if (products != null && products.Count > PageSize)
{
    <nav class="mt-2">
        <ul class="pagination justify-content-center">
            <li class="page-item @(CurrentPage == 1 ? "disabled" : "")">
                <button class="page-link" @onclick="PrevPage">Previous</button>
            </li>
            @for (int i = 1; i <= TotalPages; i++)
            {
                <li class="page-item @(i == CurrentPage ? "active" : "")">
                    <button class="page-link" @onclick="() => GoToPage(i)">@i</button>
                </li>
            }
            <li class="page-item @(CurrentPage == TotalPages ? "disabled" : "")">
                <button class="page-link" @onclick="NextPage">Next</button>
            </li>
        </ul>
    </nav>
}

@if (showDialog)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal show d-block">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@dialogTitle</h5>
                    <button class="btn-close" @onclick="CloseDialog"></button>
                </div>
                <div class="modal-body">
                    <p>Name</p>
                    <input class="form-control mb-2" placeholder="Name" @bind="form.Name" />
                    <p>Category</p>
                    <input class="form-control mb-2" placeholder="Email" @bind="form.Category" />
                    <p>Unit</p>
                    <input class="form-control mb-2" placeholder="Phone" @bind="form.unit" />
                    <p>Price</p>
                    <input class="form-control mb-2" placeholder="Address" @bind="form.Price" />
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseDialog">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveProduct">Save</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (JS != null && Store.CurrentCustomer == null)
        {
            try
            {
                await Store.LoadAuthFromStorageAsync();
                StateHasChanged(); // cập nhật UI
            }
            catch (JSDisconnectedException)
            {
                // JS chưa sẵn sàng, bỏ qua
            }
        }
    }

    string _searchQuery = "";
    string searchQuery
    {
        get => _searchQuery;
        set
        {
            if (_searchQuery != value)
            {
                _searchQuery = value;
                CurrentPage = 1; // reset về trang đầu khi filter
            }
        }
    }
    bool showDialog;
    string dialogTitle = "";
    bool isEdit;

    List<Product>? products;
    Product form = new();

    // Phân trang
    private int CurrentPage = 1;
    private int PageSize = 10;

    private IEnumerable<Product> FilteredProducts => products?.Where(p =>
        (!string.IsNullOrEmpty(p.Name) && p.Name.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)) ||
        (!string.IsNullOrEmpty(p.Category) && p.Category.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)) ||
        (!string.IsNullOrEmpty(p.unit) && p.unit.Contains(searchQuery, StringComparison.OrdinalIgnoreCase)) ||
        (!string.IsNullOrEmpty(p.Price.ToString()) && p.Price.ToString().Contains(searchQuery, StringComparison.OrdinalIgnoreCase))
    ) ?? Enumerable.Empty<Product>();

    private IEnumerable<Product> PagedProducts =>
        FilteredProducts
            .Skip((CurrentPage - 1) * PageSize)
            .Take(PageSize);

    private int TotalPages =>
        (int)Math.Ceiling((double)FilteredProducts.Count() / PageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadProducts();
    }

    async Task LoadProducts()
    {
        try
        {
            products = await ProductAPI.GetProducts();
            CurrentPage = 1; // Reset page khi reload
        }
        catch
        {
            products = new List<Product>();
        }
    }

    void OpenAdd()
    {
        // Khởi tạo form mới với các trường rỗng
        form = new Product
        {
            Name = "",
            Category = "",
            bar_code = "",
            unit = "",
            Price = 0,
            created_at = DateTime.Now
        };

        dialogTitle = "Add Products"; // Tiêu đề modal
        isEdit = false;
        showDialog = true; // Mở modal
    }


    void OpenEdit(Product p)
    {
        form = new Product
        {
            Id = p.Id,
            Name = p.Name,
            Category = p.Category,
            Price = p.Price,
            unit = p.unit,
            created_at = p.created_at
        };
        dialogTitle = "Edit Customer";
        isEdit = true;
        showDialog = true;
    }

    async Task SaveProduct()
    {
        if (isEdit)
        {
            await ProductAPI.UpdateProductAsync(form);
        }
        else
        {
            form.created_at = DateTime.Now;
            await ProductAPI.AddProductAsync(form);
        }

        showDialog = false;
        await LoadProducts();
    }

    async Task ConfirmDelete(int id)
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Bạn có chắc chắn muốn xóa sản phẩm này?");
        if (!confirmed) return;

        await DeleteProduct(id);
    }

    async Task DeleteProduct(int id)
    {
        await ProductAPI.DeleteProductAsync(id);
        await LoadProducts();
    }

    void CloseDialog() => showDialog = false;

    void PrevPage()
    {
        if (CurrentPage > 1)
        {
            CurrentPage--;
            StateHasChanged();
        }
    }

    void NextPage()
    {
        if (CurrentPage < TotalPages)
        {
            CurrentPage++;
            StateHasChanged();
        }
    }

    void GoToPage(int page)
    {
        if (page < 1) page = 1;
        if (page > TotalPages) page = TotalPages;

        CurrentPage = page;
        StateHasChanged();
    }
}
